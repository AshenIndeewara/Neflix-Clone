<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Netflix Admin - Subscribers</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Helvetica Neue', Arial, sans-serif; }
        body { background-color: #f5f5f5; color: #333; height: 100vh; overflow: hidden; }

        .container { display: flex; height: 100vh; }
        .sidebar { width: 250px; background-color: #141414; color: #e5e5e5; padding: 20px 0; }
        .main-content { flex: 1; display: flex; flex-direction: column; overflow-y: auto; background-color: #f5f5f5; }

        .logo { display: flex; align-items: center; padding: 0 20px 20px; border-bottom: 1px solid #2a2a2a; margin-bottom: 20px; color: #e50914; }
        .logo span { margin-left: 10px; font-weight: bold; }
        .nav-links { display: flex; flex-direction: column; }
        .nav-link { color: #e5e5e5; text-decoration: none; padding: 15px 20px; display: flex; align-items: center; transition: background-color 0.3s; }
        .nav-link:hover, .nav-link.active { background-color: #2a2a2a; }
        .nav-link.active { border-left: 4px solid #e50914; }
        .nav-link i { margin-right: 10px; width: 20px; text-align: center; }

        .top-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 30px; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header-right { display: flex; align-items: center; gap: 20px; }
        .search-box { display: flex; align-items: center; background: #f0f0f0; padding: 8px 15px; border-radius: 20px; }
        .search-box input { border: none; background: transparent; outline: none; margin-left: 8px; width: 200px; }
        .admin-profile { display: flex; align-items: center; gap: 10px; }
        .admin-profile img { border-radius: 50%; width: 40px; height: 40px; }

        .subscribers-header { display: flex; justify-content: space-between; align-items: center; padding: 0 30px 20px; }
        .subscriber-actions { display: flex; gap: 15px; }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .btn-primary { background-color: #e50914; color: white; }
        .btn-secondary { background-color: #2a2a2a; color: white; }

        .table-container-wrapper { margin: 0 30px 20px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden; display: flex; flex-direction: column; height: 700px; }
        .subscribers-table-container { overflow-y: auto; flex-grow: 1; }
        .subscribers-table { width: 100%; border-collapse: collapse; }
        .subscribers-table th { background-color: #f8f9fa; padding: 15px; text-align: left; font-weight: 600; color: #495057; border-bottom: 2px solid #e9ecef; position: sticky; top: 0; z-index: 10; }
        .subscribers-table td { padding: 15px; border-bottom: 1px solid #e9ecef; }
        .subscribers-table tr:hover { background-color: #f8f9fa; }

        .subscriber-info { display: flex; align-items: center; gap: 15px; }
        .subscriber-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }

        .plan, .status { padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .plan-premium { background-color: #e6f4ea; color: #137333; }
        .plan-standard { background-color: #e8f0fe; color: #1a73e8; }
        .plan-basic { background-color: #fef7e0; color: #b06000; }
        .status-active { background-color: #e6f4ea; color: #137333; }
        .status-inactive { background-color: #fef7e0; color: #b06000; }
        .status-canceled { background-color: #fce8e6; color: #c5221f; }

        .action-cell { display: flex; gap: 10px; }
        .action-btn { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; background: transparent; }
        .edit-btn { color: #1a73e8; }
        .delete-btn { color: #e50914; }

        .pagination { display: flex; justify-content: center; padding: 20px; gap: 10px; }
        .pagination-btn { padding: 8px 15px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; }
        .pagination-btn.active { background-color: #e50914; color: white; border-color: #e50914; }

        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .edit-modal { background-color: white; border-radius: 8px; width: 500px; max-width: 90%; box-shadow: 0 5px 15px rgba(0,0,0,0.3); overflow: hidden; transform: translateY(-50px); transition: transform 0.3s ease; }
        .modal-overlay.active .edit-modal { transform: translateY(0); }
        .modal-header { background-color: #e50914; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-size: 1.5rem; }
        .close-btn { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }
        .modal-body { padding: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #495057; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; }
        .form-row { display: flex; gap: 15px; }
        .form-row .form-group { flex: 1; }
        .modal-footer { padding: 15px 20px; background-color: #f8f9fa; display: flex; justify-content: flex-end; gap: 10px; }
        .btn-cancel { background-color: #6c757d; color: white; }
        .btn-save { background-color: #e50914; color: white; }
    </style>
</head>
<body>
<div class="container">
    <aside class="sidebar">
        <div class="logo">
            <i class="fab fa-netflix fa-2x"></i>
            <span>Admin Dashboard</span>
        </div>
        <nav class="nav-links">
            <a href="admin home.html" class="nav-link"><i class="fas fa-home"></i> Overview</a>
            <a href="admin Subscribers.html" class="nav-link active"><i class="fas fa-users"></i> Subscribers</a>
            <a href="#" class="nav-link"><i class="fas fa-chart-line"></i> Analytics</a>
            <a href="#" class="nav-link"><i class="fas fa-cog"></i> Settings</a>
        </nav>
    </aside>

    <main class="main-content">
        <header class="top-header">
            <div class="header-left">
                <h1>Subscriber Management</h1>
            </div>
            <div class="header-right">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search subscribers..." id="searchInput">
                </div>
                <div class="admin-profile">
                    <img src="https://avatar.iran.liara.run/public/29" alt="Admin Avatar">
                    <span>Admin User</span>
                </div>
            </div>
        </header>

        <div class="subscribers-header">
            <h2 id="all-subscribers">All Subscribers</h2>
            <div class="subscriber-actions">
                <button class="btn btn-secondary" onclick="exportAsCsv()">
                    <i class="fas fa-file-csv"></i> Export CSV
                </button>
                <button class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add Subscriber
                </button>
            </div>
        </div>

        <div class="table-container-wrapper">
            <div class="subscribers-table-container">
                <table class="subscribers-table">
                    <thead>
                        <tr>
                            <th>Subscriber</th>
                            <th>Join Date</th>
                            <th>Plan</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="pagination" id="pagination"></div>
    </main>
</div>

<div class="modal-overlay" id="editModal">
    <div class="edit-modal">
        <div class="modal-header">
            <h2>Edit Subscriber</h2>
            <button class="close-btn">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="subscriberName">Name</label>
                <input type="text" id="subscriberName" class="form-control">
            </div>
            <div class="form-group">
                <label for="subscriberEmail">Email</label>
                <input type="email" id="subscriberEmail" class="form-control">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="subscriberPlan">Plan</label>
                    <select id="subscriberPlan" class="form-control">
                        <option value="premium">Premium</option>
                        <option value="standard">Standard</option>
                        <option value="basic">Basic</option>
                        <option value="none">None</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="subscriberStatus">Status</label>
                    <select id="subscriberStatus" class="form-control">
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="canceled">Canceled</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="subscriberRole">Role</label>
                    <select id="subscriberRole" class="form-control">
                        <option value="non_paiduser">NON_PAIDUSER</option>
                        <option value="user">USER</option>
                        <option value="admin">ADMIN</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="subscriberJoinDate">Join Date</label>
                <input type="date" id="subscriberJoinDate" class="form-control">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-cancel">Cancel</button>
            <button class="btn btn-save">Save Changes</button>
        </div>
    </div>
</div>

<script>
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}
document.addEventListener('DOMContentLoaded', function() {
    const API_URL = "http://localhost:8080/v1/admin/users";
    const TOKEN = getCookie("token");

    const tableBody = document.querySelector('.subscribers-table tbody');
    const editModal = document.getElementById('editModal');
    const closeModalBtn = document.querySelector('.close-btn');
    const cancelBtn = document.querySelector('.btn-cancel');
    const deleteBtn = document.querySelector('.btn-delete');
    const saveBtn = document.querySelector('.btn-save');
    const allSubscribers = document.getElementById('all-subscribers');
    const paginationContainer = document.getElementById('pagination');
    let currentUserId = null;
    let currentPage = 0;
    const pageSize = 9  ;
    let totalPages = 1;

    async function loadUsers(page = 0) {
        try {
            const response = await fetch(`${API_URL}?page=${page}&size=${pageSize}`, {
                headers: { "Authorization": "Bearer " + TOKEN }
            });
            if (response.status !== 200) {
                window.location.href = "login.html";
                return;
            }
            const result = await response.json();
            
            const users = result.data.content;
            totalPages = result.data.totalPages;

            allSubscribers.innerText = `All Subscribers (${result.data.totalElements})`;
            renderTable(users);
            renderPagination();
        } catch (error) {
            console.error("Error loading users:", error);
            tableBody.innerHTML = `<tr><td colspan="6">Failed to load users</td></tr>`;
        }
    }

    function renderTable(users) {
        tableBody.innerHTML = '';
        users.forEach(user => {
            const plan = user.payments.length > 0 ? user.payments[0].plan.toLowerCase() : "none";
            const status = user.payments.length > 0 ? user.payments[0].status.toLowerCase() : "inactive";
            const row = `
            <tr>
                <td>
                    <div class="subscriber-info">
                        <img src="https://avatar.iran.liara.run/public/29" alt="User" class="subscriber-avatar">
                        <div>
                            <div>${user.fullName}</div>
                            <small>${user.email}</small>
                        </div>
                    </div>
                </td>
                <td>${user.joinDate}</td>
                <td><span class="plan plan-${plan}">${plan}</span></td>
                <td>${user.role}</td>
                <td><span class="status status-${status}">${status}</span></td>
                <td class="action-cell">
                    <button class="action-btn edit-btn" 
                            data-id="${user.id}" 
                            data-name="${user.fullName}" 
                            data-email="${user.email}" 
                            data-plan="${plan}" 
                            data-status="${status}"
                            data-role="${user.role}">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="action-btn delete-btn" data-id="${user.id}">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </td>
            </tr>`;
            tableBody.insertAdjacentHTML('beforeend', row);
        });
        bindEditButtons();
    }

    function renderPagination() {
        paginationContainer.innerHTML = '';
        if (totalPages <= 1) return;

        for (let i = 0; i < totalPages; i++) {
            const btn = document.createElement('button');
            btn.classList.add('pagination-btn');
            if (i === currentPage) btn.classList.add('active');
            btn.innerText = i + 1;
            btn.addEventListener('click', () => {
                currentPage = i;
                loadUsers(currentPage);
            });
            paginationContainer.appendChild(btn);
        }
    }

    function bindEditButtons() {
        document.querySelectorAll('.edit-btn').forEach(button => {
            //console.log("button", button);
            button.addEventListener('click', function() {
                currentUserId = this.dataset.id;
                document.getElementById('subscriberName').value = this.dataset.name;
                document.getElementById('subscriberEmail').value = this.dataset.email;
                document.getElementById('subscriberPlan').value = this.dataset.plan;
                document.getElementById('subscriberStatus').value = this.dataset.status;
                document.getElementById('subscriberRole').value = this.dataset.role.toLowerCase();
                openModal();
            });
        });
    }

    function openModal() {
        editModal.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeModal() {
        editModal.classList.remove('active');
        document.body.style.overflow = '';
    }

    function deleteUser(userId) {
        if (!userId) return;
        if (!confirm("Are you sure you want to delete this subscriber?")) return;

        fetch(`${API_URL}/${userId}`, {
            method: 'DELETE',
            headers: { "Authorization": "Bearer " + TOKEN }
        })
        .then(response => {
            if (!response.ok) throw new Error("Failed to delete user");
            alert('Subscriber deleted successfully!');
            loadUsers(currentPage);
        })
        .catch(error => {
            console.error(error);
            alert('Error deleting subscriber.');
        });
    }

    closeModalBtn.addEventListener('click', closeModal);
    cancelBtn.addEventListener('click', closeModal);
    editModal.addEventListener('click', e => { if (e.target === editModal) closeModal(); });
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });
    document.querySelector('.table-container-wrapper').addEventListener('click', e => {
        if (e.target.closest('.delete-btn')) {
            const userId = e.target.closest('.delete-btn').dataset.id;
            deleteUser(userId);
        }
    });
    

    saveBtn.addEventListener('click', async function() {
        if (!currentUserId) return;
        const newRole = document.getElementById('subscriberRole').value.toUpperCase();
        try {
            const response = await fetch(`${API_URL}/${currentUserId}/role?role=${newRole}`, {
                method: 'PUT',
                headers: { "Authorization": "Bearer " + TOKEN }
            });
            if (!response.ok) throw new Error("Failed to update role");
            alert('Subscriber role updated successfully!');
            closeModal();
            loadUsers(currentPage);
        } catch (error) {
            console.error(error);
            alert('Error updating subscriber.');
        }
    });

    loadUsers();
});

function exportAsCsv() {
    let csvContent = "data:text/csv;charset=utf-8,Name,Email,Plan,Role,Status\n";
    document.querySelectorAll('.subscribers-table tbody tr').forEach(row => {
        const cols = row.querySelectorAll('td');
        const name = cols[0].querySelector('div div').innerText.trim();
        const email = cols[0].querySelector('small').innerText.trim();
        const plan = cols[2].innerText.trim();
        const role = cols[3].innerText.trim();
        const status = cols[4].innerText.trim();
        csvContent += `${name},${email},${plan},${role},${status}\n`;
    });
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "subscribers.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
</script>
</body>
</html>
